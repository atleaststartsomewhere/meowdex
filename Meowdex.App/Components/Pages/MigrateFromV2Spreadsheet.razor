@using Meowdex.App.Models
@using Meowdex.App.Services
@inject CatRosterService RosterService

@page "/migrate-from-v2-spreadsheet"

<PageTitle>Migrate From V2 Spreadsheet</PageTitle>

<h1>Migrate From V2 Spreadsheet</h1>
<p>Paste tab-delimited rows copied from Google Sheets. Duplicate rows are ignored.</p>

<div class="panel">
    <label for="pasteBox" class="form-label">Spreadsheet Data</label>
    <InputTextArea id="pasteBox" class="form-control paste-box" @bind-Value="_input" />

    <div class="actions">
        <button class="btn btn-primary" @onclick="ImportAsync" disabled="@string.IsNullOrWhiteSpace(_input)">Import Into cats.json</button>
    </div>
</div>

@if (_summary is not null)
{
    <section class="panel mt-3">
        <h2>Import Summary</h2>
        <ul>
            <li>Total lines: @_summary.TotalLines</li>
            <li>Parsed rows: @_summary.ParsedRows</li>
            <li>Imported: @_summary.Imported</li>
            <li>Skipped duplicates: @_summary.SkippedDuplicates</li>
            <li>Errors: @_summary.Errors.Count</li>
        </ul>

        @if (_summary.Errors.Count > 0)
        {
            <h3>Errors</h3>
            <ul>
                @foreach (var error in _summary.Errors)
                {
                    <li>@error</li>
                }
            </ul>
        }
    </section>
}

@code {
    private string _input = string.Empty;
    private ImportSummary? _summary;

    private async Task ImportAsync()
    {
        var lines = _input.Replace("\r", string.Empty)
            .Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        var summary = new ImportSummary { TotalLines = lines.Length };
        var parsed = new List<CatProfile>();

        for (var i = 0; i < lines.Length; i++)
        {
            if (TryParseLine(lines[i], i + 1, out var cat, out var error))
            {
                summary.ParsedRows++;
                parsed.Add(cat!);
            }
            else
            {
                summary.Errors.Add(error!);
            }
        }

        var existing = await RosterService.GetCatsAsync();
        var seen = existing.Select(BuildDuplicateKey).ToHashSet(StringComparer.OrdinalIgnoreCase);
        var unique = new List<CatProfile>();

        foreach (var cat in parsed)
        {
            var key = BuildDuplicateKey(cat);
            if (!seen.Add(key))
            {
                summary.SkippedDuplicates++;
                continue;
            }

            unique.Add(cat);
        }

        var imported = await RosterService.AddCatsAsync(unique);
        summary.Imported = imported.Count;

        _summary = summary;
    }

    private static bool TryParseLine(string line, int lineNumber, out CatProfile? cat, out string? error)
    {
        cat = null;
        error = null;

        var parts = line.Split('\t');
        if (parts.Length != 16)
        {
            error = $"Line {lineNumber}: expected 16 tab-separated columns, got {parts.Length}.";
            return false;
        }

        var name = parts[0].Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            error = $"Line {lineNumber}: name is empty.";
            return false;
        }

        var isRetired = parts[1].Trim().Equals("yes", StringComparison.OrdinalIgnoreCase);

        var numbers = new int[14];
        for (var i = 0; i < 14; i++)
        {
            if (!int.TryParse(parts[i + 2], out numbers[i]))
            {
                error = $"Line {lineNumber}: invalid number '{parts[i + 2]}' at column {i + 3}.";
                return false;
            }
        }

        cat = new CatProfile
        {
            Name = name,
            IsRetired = isRetired,
            Gender = CatGender.Fluid,
            Sexuality = CatSexuality.Bi,
            StrengthCurrent = numbers[0],
            StrengthBase = numbers[1],
            DexterityCurrent = numbers[2],
            DexterityBase = numbers[3],
            StaminaCurrent = numbers[4],
            StaminaBase = numbers[5],
            IntellectCurrent = numbers[6],
            IntellectBase = numbers[7],
            SpeedCurrent = numbers[8],
            SpeedBase = numbers[9],
            CharismaCurrent = numbers[10],
            CharismaBase = numbers[11],
            LuckCurrent = numbers[12],
            LuckBase = numbers[13]
        };

        return true;
    }

    private static string BuildDuplicateKey(CatProfile cat)
    {
        return string.Join("|",
            cat.Name.Trim().ToLowerInvariant(),
            cat.StrengthCurrent,
            cat.StrengthBase,
            cat.DexterityCurrent,
            cat.DexterityBase,
            cat.StaminaCurrent,
            cat.StaminaBase,
            cat.IntellectCurrent,
            cat.IntellectBase,
            cat.SpeedCurrent,
            cat.SpeedBase,
            cat.CharismaCurrent,
            cat.CharismaBase,
            cat.LuckCurrent,
            cat.LuckBase,
            cat.IsRetired);
    }

    private sealed class ImportSummary
    {
        public int TotalLines { get; set; }
        public int ParsedRows { get; set; }
        public int Imported { get; set; }
        public int SkippedDuplicates { get; set; }
        public List<string> Errors { get; } = [];
    }
}
